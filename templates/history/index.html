{% extends 'base.html' %}

{% block title %}Transaction History{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="chart-container">
            <canvas id="transactionChart"></canvas>
        </div>
    </div>
</div>

<h1>Expenses</h1>
<table class="transaction-table">
    <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Expense Type</th>
        <th>Image</th>
        <th>Actions</th>
    </tr>
    {% for expense in expenses %}
    <tr>
        <td>{{ expense.date }}</td>
        <td>{{ expense.amount }}</td>
        <td>
            {% if expense.expense_type %}
                {{ expense.expense_type.name }}
            {% elif expense.manual_expense_type %}
                {{ expense.manual_expense_type }}
            {% endif %}
        </td>
        <td>{% if expense.image %}<img src="{{ expense.image.url }}" alt="Expense Image" width="50">{% endif %}</td>
        <td class="action-buttons">
            <a href="{% url 'edit_expense' expense.pk %}" class="edit">Edit</a>
            <a href="{% url 'delete_expense' expense.pk %}" class="delete">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>

<h1>Incomes</h1>
<table class="transaction-table">
    <tr>
        <th>Date</th>
        <th>Amount</th>
        <th>Income Type</th>
        <th>Image</th>
        <th>Actions</th>
    </tr>
    {% for income in incomes %}
    <tr>
        <td>{{ income.date }}</td>
        <td>{{ income.amount }}</td>
        <td>{{ income.income_type.name }}</td>
        <td>{% if income.image %}<img src="{{ income.image.url }}" alt="Income Image" width="50">{% endif %}</td>
        <td class="action-buttons">
            <a href="{% url 'edit_income' income.pk %}" class="edit">Edit</a>
            <a href="{% url 'delete_income' income.pk %}" class="delete">Delete</a>
        </td>
    </tr>
    {% endfor %}
</table>

<script>
    const ctx = document.getElementById('transactionChart').getContext('2d');
    const transactionChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Expenses', 'Incomes'],
            datasets: [{
                label: 'Transactions',
                data: [{{ total_expenses }}, {{ total_incomes }}],
                backgroundColor: ['#dc3545', '#28a745'],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: '#343a40'
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += '$' + context.parsed;
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
</script>
{% endblock %}
